
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>labbench.data &#8212; labbench v0.20</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="labbench v0.20">
  <link rel="canonical" href="../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../..//_static/NISTStyle.css">
  <link rel="stylesheet" href="../..//_static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench v0.20</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for labbench.data</h1><div class="highlight"><pre>
<span></span><span class="c1"># This software was developed by employees of the National Institute of</span>
<span class="c1"># Standards and Technology (NIST), an agency of the Federal Government.</span>
<span class="c1"># Pursuant to title 17 United States Code Section 105, works of NIST employees</span>
<span class="c1"># are not subject to copyright protection in the United States and are</span>
<span class="c1"># considered to be in the public domain. Permission to freely use, copy,</span>
<span class="c1"># modify, and distribute this software and its documentation without fee is</span>
<span class="c1"># hereby granted, provided that this notice and disclaimer of warranty appears</span>
<span class="c1"># in all copies.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND, EITHER</span>
<span class="c1"># EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY WARRANTY</span>
<span class="c1"># THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM</span>
<span class="c1"># INFRINGEMENT, AND ANY WARRANTY THAT THE DOCUMENTATION WILL CONFORM TO THE</span>
<span class="c1"># SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE. IN NO EVENT</span>
<span class="c1"># SHALL NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT,</span>
<span class="c1"># INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES, ARISING OUT OF, RESULTING FROM,</span>
<span class="c1"># OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON</span>
<span class="c1"># WARRANTY, CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED</span>
<span class="c1"># BY PERSONS OR PROPERTY OR OTHERWISE, AND WHETHER OR NOT LOSS WAS SUSTAINED</span>
<span class="c1"># FROM, OR AROSE OUT OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES</span>
<span class="c1"># PROVIDED HEREUNDER. Distributions of NIST software should also include</span>
<span class="c1"># copyright and licensing statements of any third-party software that are</span>
<span class="c1"># legally bundled with the code in compliance with the conditions of those</span>
<span class="c1"># licenses.</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;StateAggregator&#39;</span><span class="p">,</span> <span class="s1">&#39;StatesToRelationalTable&#39;</span><span class="p">,</span>
           <span class="s1">&#39;StatesToCSV&#39;</span><span class="p">,</span> <span class="s1">&#39;StatesToSQLite&#39;</span><span class="p">,</span>
           <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;read_relational&#39;</span><span class="p">,</span> <span class="s1">&#39;to_feather&#39;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">suppress</span><span class="p">,</span> <span class="n">ExitStack</span>
<span class="kn">from</span> <span class="nn">.core</span> <span class="k">import</span> <span class="n">Device</span>
<span class="kn">from</span> <span class="nn">.host</span> <span class="k">import</span> <span class="n">Host</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pyarrow.feather</span> <span class="k">import</span> <span class="n">read_feather</span>


<div class="viewcode-block" id="StateAggregator"><a class="viewcode-back" href="../../labbench.html#labbench.data.StateAggregator">[docs]</a><span class="k">class</span> <span class="nc">StateAggregator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Aggregate state information from multiple devices. This can be the basis</span>
<span class="sd">        for automatic database logging.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Map the state instance of a device (key) to a name (value)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># These dictionaries are keyed by Device instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__always</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__never</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="c1"># log_handler = logging.bufHandler()</span>
        <span class="c1"># log_handler.setLevel(logging.DEBUG)</span>
        <span class="c1"># log_fmt = &#39;%(asctime)s.%(msecs)03d - {name} - %(levelname)s - %(message)s - %(pathname)s:%(lineno)d&#39;\</span>
        <span class="c1">#           .format(self.__class__.__name__)</span>
        <span class="c1"># #    coloredlogs.install(level=&#39;DEBUG&#39;, logger=logger)</span>
        <span class="c1"># log_handler.setFormatter(coloredlogs.ColoredFormatter(log_fmt))</span>
        <span class="c1"># self.logger.addHandler(log_handler)</span>

<div class="viewcode-block" id="StateAggregator.key"><a class="viewcode-back" href="../../labbench.html#labbench.data.StateAggregator.key">[docs]</a>    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate a name for a state based on the names of</span>
<span class="sd">            a device and one of its states or settings.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{device_name}</span><span class="s1">_</span><span class="si">{state_name}</span><span class="s1">&#39;</span></div>

    <span class="k">def</span> <span class="nf">__on_set_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Callback for changes observed when device states are set.</span>

<span class="sd">        :param dict change: callback info dictionary generated by traitlets</span>
<span class="sd">        :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_device</span><span class="p">],</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="StateAggregator.set_device_labels"><a class="viewcode-back" href="../../labbench.html#labbench.data.StateAggregator.set_device_labels">[docs]</a>    <span class="k">def</span> <span class="nf">set_device_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Manually choose device name for a device instance.</span>

<span class="sd">            :param dict mapping: name mapping, formatted as {device_object: &#39;device name&#39;}</span>
<span class="sd">            :returns: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{device}</span><span class="s1"> is not an instance of Device&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">v</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span></div>

<div class="viewcode-block" id="StateAggregator.observe"><a class="viewcode-back" href="../../labbench.html#labbench.data.StateAggregator.observe">[docs]</a>    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="p">[],</span> <span class="n">never</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; Deprecated - use `observe_states` instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s1">&#39;observe has been deprecated in favor of observe_states and will be removed soon&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe_states</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">always</span><span class="p">,</span> <span class="n">never</span><span class="p">)</span></div>

<div class="viewcode-block" id="StateAggregator.observe_states"><a class="viewcode-back" href="../../labbench.html#labbench.data.StateAggregator.observe_states">[docs]</a>    <span class="k">def</span> <span class="nf">observe_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">always</span><span class="o">=</span><span class="p">[],</span> <span class="n">never</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;connected&#39;</span><span class="p">]):</span>
        <span class="sd">&#39;&#39;&#39; Configure Each time a device state is set from python,</span>
<span class="sd">            intercept the value to include in the aggregate</span>
<span class="sd">            state.</span>

<span class="sd">            Device may be a single device instance, or an</span>
<span class="sd">            several devices in an iterable (such as a list</span>
<span class="sd">            or tuple) to apply to each one.</span>

<span class="sd">            Subsequent calls to :func:`observe_states` replace</span>
<span class="sd">            the existing list of observed states for each</span>
<span class="sd">            device.</span>

<span class="sd">            :param devices: Device instance or iterable of Device instances</span>
<span class="sd">            :param bool changes: Whether to automatically log each time a state is set for the supplied device(s)</span>
<span class="sd">            :param always: name (or iterable of multiple names) of states to actively update on each call to get()</span>
<span class="sd">            :param never: name (or iterable of multiple names) of states to exclude from aggregated result (overrides :param:`always`)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">devices</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">devices</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">always</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">always</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">always</span> <span class="o">=</span> <span class="p">[</span><span class="n">always</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{device}</span><span class="s1"> is not an instance of Device&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">device</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__whoisthis</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Could not automatically determine unique names of device instances!</span>
<span class="s1">                               Set manually with the set_label method &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
                <span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_set_callback</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement me on changes=False&#39;</span><span class="p">)</span>
                <span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">unobserve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_set_callback</span><span class="p">)</span>
                <span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">unobserve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_set_callback</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">always</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">always</span>
            <span class="k">if</span> <span class="n">never</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">never</span></div>

<div class="viewcode-block" id="StateAggregator.observe_settings"><a class="viewcode-back" href="../../labbench.html#labbench.data.StateAggregator.observe_settings">[docs]</a>    <span class="k">def</span> <span class="nf">observe_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">always</span><span class="o">=</span><span class="p">[],</span> <span class="n">never</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;connected&#39;</span><span class="p">]):</span>
        <span class="sd">&#39;&#39;&#39; Configure Each time a device setting is set from python,</span>
<span class="sd">            intercept the value to include in the aggregate</span>
<span class="sd">            state.</span>

<span class="sd">            Device may be a single device instance, or an</span>
<span class="sd">            several devices in an iterable (such as a list</span>
<span class="sd">            or tuple) to apply to each one.</span>

<span class="sd">            Subsequent calls to :func:`observe_settings` replace</span>
<span class="sd">            the existing list of observed states for each</span>
<span class="sd">            device.</span>

<span class="sd">            :param devices: Device instance or iterable of Device instances</span>
<span class="sd">            :param bool changes: Whether to automatically log each time a state is set for the supplied device(s)</span>
<span class="sd">            :param always: name (or iterable of multiple names) of settings to actively update on each call to get()</span>
<span class="sd">            :param never: name (or iterable of multiple names) of settings to exclude from aggregated result (overrides :param:`always`)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">devices</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">devices</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">always</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">always</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">always</span> <span class="o">=</span> <span class="p">[</span><span class="n">always</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{device}</span><span class="s1"> is not an instance of Device&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">device</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__whoisthis</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Could not automatically determine unique names of device instances!</span>
<span class="s1">                               Set manually with the set_label method &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
                <span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_set_callback</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement me on changes=False&#39;</span><span class="p">)</span>
                <span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">unobserve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_set_callback</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">always</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="p">]</span> <span class="o">=</span> <span class="n">always</span>
            <span class="k">if</span> <span class="n">never</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="p">]</span> <span class="o">=</span> <span class="n">never</span></div>

<div class="viewcode-block" id="StateAggregator.get"><a class="viewcode-back" href="../../labbench.html#labbench.data.StateAggregator.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Aggregate and return the current device states as configured</span>
<span class="sd">            with :func:`observe`.</span>

<span class="sd">            :returns: dictionary of aggregated states. Keys are strings defined by :func:`key` (defaults to &#39;{device name}_{state name}&#39;). Values are the type and value of the corresponding state of the device instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Perform gets for each state called out in manual_include</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">traits</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="n">f</span><span class="s1">&#39;the requested state </span><span class="si">{attr}</span><span class="s1"> does not exist in </span><span class="si">{device}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="c1"># Remove keys corresponding with self.__never</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">state</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c1"># Perform gets for each setting called out in self.__always</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">settings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__always</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">traits</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="n">f</span><span class="s1">&#39;the requested setting </span><span class="si">{attr}</span><span class="s1"> does not exist in </span><span class="si">{device}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="c1"># Remove keys corresponding with self.__never</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">settings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__never</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">settings</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">_spy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a dictionary of the most recently observed states</span>
<span class="sd">            without pulling new states from any devices (but including</span>
<span class="sd">            states included to `always` aggregate). Does not</span>
<span class="sd">            include the current timestamp.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__auto</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__whoisthis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">from_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Introspect into the caller to find the name of an object .</span>

<span class="sd">        :param target: device instance</span>
<span class="sd">        :param from_depth: number of callers outside of the current frame</span>
<span class="sd">        :return: name of the Device</span>
<span class="sd">        &#39;&#39;&#39;</span>
<span class="c1">#        # If the context is a function, look in its first argument,</span>
<span class="c1">#        # in case it is a method. Search its class instance.</span>
<span class="c1">#        if len(ret) == 0 and len(f.frame.f_code.co_varnames)&gt;0:</span>
<span class="c1">#            obj = f.frame.f_locals[f.frame.f_code.co_varnames[0]]</span>
<span class="c1">#            for k, v in obj.__dict__.items():</span>
<span class="c1">#                if isinstance(v, Device):</span>
<span class="c1">#                    ret[k] = v</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">())[</span><span class="n">from_depth</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">k</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">target</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">k</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;failed to automatically label {repr(obj)}&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">MungerBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This is where ugly but necessary sausagemaking happens to organize</span>
<span class="sd">        in a relational form according to the master database.</span>

<span class="sd">        The following conversions to relational files are attempted in order to</span>
<span class="sd">        convert each value in the row dictionary:</span>

<span class="sd">        1. Text containing a valid file or directory *outside* of the root data</span>
<span class="sd">           directory is made relational by moving the file or directory into</span>
<span class="sd">           the current row. The text is replaced with the updated relative path;</span>
<span class="sd">        2. Text longer than `text_relational_min` is dumped into a relational</span>
<span class="sd">           text file;</span>
<span class="sd">        3. 1- or 2-D data is converted to a pandas Series or DataFrame, and</span>
<span class="sd">           dumped into a relational file defined by the extension set by</span>
<span class="sd">           `nonscalar_file_type`</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                 <span class="n">text_relational_min</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                 <span class="n">force_relational</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;host_log&#39;</span><span class="p">],</span>
                 <span class="n">dirname_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{id}</span><span class="s1"> </span><span class="si">{host_time}</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">nonscalar_file_type</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span>
                 <span class="n">metadata_dirname</span><span class="o">=</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_relational_min</span> <span class="o">=</span> <span class="n">text_relational_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_relational</span> <span class="o">=</span> <span class="n">force_relational</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirname_fmt</span> <span class="o">=</span> <span class="n">dirname_fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonscalar_file_type</span> <span class="o">=</span> <span class="n">nonscalar_file_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dirname</span> <span class="o">=</span> <span class="n">metadata_dirname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Overload this to add some setup logic</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Overload this for teardown logic</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Break special cases of row items that need to be broken out into</span>
<span class="sd">        relational files. The row valueis replaced in-place with the relative</span>
<span class="sd">        path to the data saved on disk.</span>

<span class="sd">        :param row: dictionary of {&#39;entry_name&#39;: &quot;entry_value&quot;} pairs</span>
<span class="sd">        :return: the row dictionary, replacing special entries with the relative path to the saved data file</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">is_path</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># A path outside the relational database tree</span>
            <span class="k">if</span> <span class="n">is_path</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c1"># A file or directory that should be moved in</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_external_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="c1"># A long string that should be written to a text file</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_relational_min</span>\
                   <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_relational</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_text</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="c1"># vector, table, matrix, etc.</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_nonscalar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dirname</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dev</span><span class="p">,</span> <span class="n">devname</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dev</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">trait_names</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_relational_min</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_from_text</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">summary</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_from_nonscalar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">summary</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">summary</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                        <span class="n">summary</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">summary</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_metadata</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s1">&#39;overwrite&#39;</span><span class="p">):</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Workaround for bytes/str encoding quirk underlying pandas 0.23.1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_nonscalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Write nonscalar (potentially array-like, or a python object) data</span>
<span class="sd">        to a file, and return a path to the file</span>

<span class="sd">        :param name: name of the entry to write, used as the filename</span>
<span class="sd">        :param value: the object containing array-like data</span>
<span class="sd">        :param row: row dictionary, or None (the default) to write to the metadata folder</span>
<span class="sd">        :return: the path to the file, relative to the directory that contains the master database</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;pickle&#39;</span><span class="p">):</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;feather&#39;</span><span class="p">:</span>
                <span class="n">to_feather</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;sqlite not implemented for relational files&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;extension </span><span class="si">{ext}</span><span class="s2"> doesn&#39;t match a known format&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonscalar_file_type</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="c1"># We couldn&#39;t make a DataFrame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Failed to form DataFrame from {repr(name)}; pickling object instead&quot;</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_metadata</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_relational</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="c1"># Workaround for bytes/str encoding quirk underlying pandas 0.23.1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">write</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                    <span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_external_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span>
                            <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntries</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_relational</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_import_from_file</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Write a string data to a file</span>

<span class="sd">        :param name: name of the parameter (helps to determine file path)</span>
<span class="sd">        :param value: the string to write to file</span>
<span class="sd">        :param row: the row to infer timestamping, or None to write to metadata</span>
<span class="sd">        :param ext: file extension</span>
<span class="sd">        :return: the path to the file, relative to the directory that contains the master database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_relational</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># The following methods need to be implemented in subclasses.</span>
    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Key to use for the relative data in the master database?</span>

<span class="sd">        :param stream: stream for writing to the relational data file</span>
<span class="sd">        :return: the key</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_open_relational</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Open a stream / IO buffer for writing relational data, given</span>
<span class="sd">            the master database column, index, and the row dictionary.</span>

<span class="sd">            :param name: the column name of the relational data in the master db</span>
<span class="sd">            :param index: the index name of of the data in the master db</span>
<span class="sd">            :param row: the dictionary containing the row of data at `index`</span>

<span class="sd">            :returns: an open buffer object for writing data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_open_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Open a stream / IO buffer for writing metadata, given</span>
<span class="sd">            the name of the metadata.</span>

<span class="sd">            :returns: an open buffer object for writing metadata to the file</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_import_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">MungeToDirectory</span><span class="p">(</span><span class="n">MungerBase</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Implement data munging into subdirectories. This is fast but can produce</span>
<span class="sd">        an unweildy number of subdirectories if there are many runs.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_open_relational</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;host_time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;no timestamp yet from host yet; this shouldn&#39;t happen :(&quot;</span><span class="p">)</span>

        <span class="n">relpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_path_heirarchy</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">relpath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="s1">&#39;wb+&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dirname</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">FileExistsError</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="s1">&#39;wb+&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Key to use for the relative data in the master database?</span>

<span class="sd">        :param stream: stream for writing to the relational data file</span>
<span class="sd">        :return: the key</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_import_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="c1"># Retry moves for several seconds in case the file is in the process</span>
        <span class="c1"># of being closed</span>
        <span class="nd">@util</span><span class="o">.</span><span class="n">until_timeout</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">move</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">move</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;moved {repr(old_path)} to {repr(dest)}&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;relational file was still open in another program; fallback to copy instead of rename&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_path_heirarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirname_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># TODO: Find a more generic way to force valid path name</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">relpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relpath</span>


<span class="k">class</span> <span class="nc">TarFileIO</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; For appending data into new files in a tarfile</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_tarfile</span><span class="p">,</span> <span class="n">relname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#        self.tarbase = tarbase</span>
        <span class="c1">#        self.tarname = tarname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span> <span class="o">=</span> <span class="n">open_tarfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">relname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>

<span class="c1">#    def write(self, data, encoding=&#39;ascii&#39;):</span>
<span class="c1">#        if isinstance(data, str):</span>
<span class="c1">#            data = bytes(data, encoding=encoding)</span>
<span class="c1">#        super(TarFileIO,self).write(data)</span>
<span class="c1">#</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># First: dump the data into the tar file</span>
        <span class="c1">#        tarpath = os.path.join(self.tarbase, self.tarname)</span>
        <span class="c1">#        f = tarfile.open(tarpath, &#39;a&#39;)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">getnames</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.name}</span><span class="s1"> already exists in </span><span class="si">{self.tarfile.name}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Then make sure to close everything</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">MungeToTar</span><span class="p">(</span><span class="n">MungerBase</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Implement data munging into a tar file. This is slower than</span>
<span class="sd">        MungeToDirectory but is tidier on the filesystem.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tarname</span> <span class="o">=</span> <span class="s1">&#39;data.tar&#39;</span>

    <span class="k">def</span> <span class="nf">_open_relational</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;host_time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;no timestamp yet from host yet; this shouldn&#39;t happen :(&quot;</span><span class="p">)</span>

        <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">row</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TarFileIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dirname</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TarFileIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">FileExistsError</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarname</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Where is the file relative to the master database?</span>

<span class="sd">        :param path: path of the file</span>
<span class="sd">        :return: path to the file relative to the master database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">_import_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gettarinfo</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="nd">@util</span><span class="o">.</span><span class="n">until_timeout</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">remove</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotADirectoryError</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;moved </span><span class="si">{old_path}</span><span class="s1"> to into tar file as </span><span class="si">{dest}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;could not remove old file or directory </span><span class="si">{old_path}</span><span class="s1">&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="StatesToRelationalTable"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable">[docs]</a><span class="k">class</span> <span class="nc">StatesToRelationalTable</span><span class="p">(</span><span class="n">StateAggregator</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Abstract base class for loggers that queue dictionaries of data before writing</span>
<span class="sd">        to disk. This extends :class:`StateAggregator` to support</span>

<span class="sd">        #. queuing aggregate state of devices by lists of dictionaries;</span>
<span class="sd">        #. custom metadata in each queued aggregate state entry; and</span>
<span class="sd">        #. custom response to non-scalar data (such as relational databasing).</span>

<span class="sd">        :param str path: Base path to use for the master database</span>
<span class="sd">        :param bool overwrite: Whether to overwrite the master database if it exists (otherwise, append)</span>
<span class="sd">        :param text_relational_min: Text with at least this many characters is stored as a relational text file instead of directly in the database</span>
<span class="sd">        :param force_relational: A list of columns that should always be stored as relational data instead of directly in the database</span>
<span class="sd">        :param nonscalar_file_type: The data type to use in non-scalar (tabular, vector, etc.) relational data</span>
<span class="sd">        :param metadata_dirname: The name of the subdirectory that should be used to store metadata (device connection parameters, etc.)</span>
<span class="sd">        :param tar: Whether to store the relational data within directories in a tar file, instead of subdirectories</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">index_label</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">text_relational_min</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                 <span class="n">force_relational</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;host_log&#39;</span><span class="p">],</span>
                 <span class="n">dirname_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{id}</span><span class="s1"> </span><span class="si">{host_time}</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">nonscalar_file_type</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span>
                 <span class="n">metadata_dirname</span><span class="o">=</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span>
                 <span class="n">tar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">StatesToRelationalTable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_row_preprocessor</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Need to assign in the namespace like this to detect its name can be</span>
        <span class="c1"># detected</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">Host</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe_states</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>

        <span class="k">if</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">munge_cls</span> <span class="o">=</span> <span class="n">MungeToTar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">munge_cls</span> <span class="o">=</span> <span class="n">MungeToDirectory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">munge</span> <span class="o">=</span> <span class="n">munge_cls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                               <span class="n">text_relational_min</span><span class="o">=</span><span class="n">text_relational_min</span><span class="p">,</span>
                               <span class="n">force_relational</span><span class="o">=</span><span class="n">force_relational</span><span class="p">,</span>
                               <span class="n">dirname_fmt</span><span class="o">=</span><span class="n">dirname_fmt</span><span class="p">,</span>
                               <span class="n">nonscalar_file_type</span><span class="o">=</span><span class="n">nonscalar_file_type</span><span class="p">,</span>
                               <span class="n">metadata_dirname</span><span class="o">=</span><span class="n">metadata_dirname</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

<div class="viewcode-block" id="StatesToRelationalTable.set_row_preprocessor"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.set_row_preprocessor">[docs]</a>    <span class="k">def</span> <span class="nf">set_row_preprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Define a function that is called to modify each pending data row</span>
<span class="sd">            before it is committed to disk. It should accept a single argument,</span>
<span class="sd">            a function or other callable that accepts a single argument (the</span>
<span class="sd">            row dictionary) and returns the dictionary modified for write</span>
<span class="sd">            to disk.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_row_preprocessor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_row_preprocessor</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;func argument must be callable or None&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="StatesToRelationalTable.append"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add a new row of data to the list of data that awaits write</span>
<span class="sd">            to disk.</span>

<span class="sd">            This cache of pending data row is in the dictionary `self.pending`.</span>
<span class="sd">            Each row is represented as a dictionary of</span>
<span class="sd">            pairs formatted as {&#39;column_name&#39;: &#39;row_value&#39;}. These</span>
<span class="sd">            pairs come from a combination of 1) keyword arguments passed as</span>
<span class="sd">            `kwargs`, 2) a single dictionary argument, and/or 3) state traits</span>
<span class="sd">            configured automatically with `self.observe_states`.</span>

<span class="sd">            The first pass at forming the row is the single dictionary argument ::</span>

<span class="sd">                row = {&#39;name1&#39;: value1, &#39;name2&#39;: value2, &#39;name3&#39;: value3}</span>
<span class="sd">                db.append(row)</span>

<span class="sd">            The second pass is to update with values as configured with</span>
<span class="sd">            `self.observe_states`.</span>

<span class="sd">            Keyword arguments are passed in as ::</span>

<span class="sd">                db.append(name1=value1, name2=value2, nameN=valueN)</span>

<span class="sd">            Simple &quot;scalar&quot; database types like numbers, booleans, and strings</span>
<span class="sd">            are added</span>
<span class="sd">            directly to the table. Non-scalar or multidimensional values are stored</span>
<span class="sd">            in a separate file (as defined in :func:`set_path_format`), and the path</span>
<span class="sd">            to this file is stored in the table.</span>

<span class="sd">            The row of data is appended to list of rows pending write to</span>
<span class="sd">            disk, `self.pending`. Nothing is written to disk until</span>
<span class="sd">            :func:`write`.</span>

<span class="sd">            :param bool copy=True: When `True` (the default), use a deep copy of `data` to avoid problems with overwriting references to data if `data` is reused during test. This takes some extra time; set to `False` to skip this copy operation.</span>

<span class="sd">            :return: the dictionary representation of the row added to `self.pending`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">do_copy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Start with input arguments</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#            if not isinstance(args[0], dict):</span>
            <span class="c1">#                raise TypeError(&#39;argument to append must be a dictionary&#39;)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">do_copy</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Pull in observed states</span>
        <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                                 <span class="k">if</span> <span class="n">do_copy</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">())))</span>

        <span class="c1"># Pull in keyword arguments</span>
        <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span> <span class="k">if</span> <span class="n">do_copy</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span></div>

<div class="viewcode-block" id="StatesToRelationalTable.write"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Commit any pending rows to the master database, converting</span>
<span class="sd">            non-scalar data to data files, and replacing their dictionary value</span>
<span class="sd">            with the relative path to the data file.</span>

<span class="sd">            :returns: the number of rows written</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_preprocessor</span>
            <span class="n">pending</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">proc</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_master</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">count</span></div>

    <span class="k">def</span> <span class="nf">_write_master</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Write pending data. This is an abstract base method (must be</span>
<span class="sd">            implemented by inheriting classes)</span>

<span class="sd">            :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="StatesToRelationalTable.clear"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Remove any queued data that has been added by append.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="StatesToRelationalTable.set_relational_file_format"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.set_relational_file_format">[docs]</a>    <span class="k">def</span> <span class="nf">set_relational_file_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Set the format to use for relational data files.</span>

<span class="sd">            :param str format: one of &#39;csv&#39;, &#39;json&#39;, &#39;feather&#39;, or &#39;pickle&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;set_nonscalar_file_type is deprecated; set when creating</span>
<span class="s1">                         the database object instead with the nonscalar_output flag&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;feather&#39;</span><span class="p">,</span> <span class="s1">&#39;pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;relational file data format </span><span class="si">{format}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="o">.</span><span class="n">nonscalar_file_type</span> <span class="o">=</span> <span class="nb">format</span></div>

<div class="viewcode-block" id="StatesToRelationalTable.set_path_format"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.set_path_format">[docs]</a>    <span class="k">def</span> <span class="nf">set_path_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Set the path name convention for relational files that is used when</span>
<span class="sd">            a table entry contains non-scalar (multidimensional) information and will</span>
<span class="sd">            need to be stored in a separate file. The entry in the aggregate states table</span>
<span class="sd">            becomes the path to the file.</span>

<span class="sd">            The format string follows the syntax of python&#39;s python&#39;s built-in :func:`str.format`.\</span>
<span class="sd">            You may use any keys from the table to form the path. For example, consider a\</span>
<span class="sd">            scenario where aggregate device states includes `inst1_frequency` of `915e6`,\</span>
<span class="sd">            and :func:`append` has been called as `append(dut=&quot;DUT15&quot;)`. If the current\</span>
<span class="sd">            aggregate state entry includes inst1_frequency=915e6, then the format string\</span>
<span class="sd">            &#39;{dut}/{inst1_frequency}&#39; means relative data path &#39;DUT15/915e6&#39;.</span>

<span class="sd">            :param format: a string compatible with :func:`str.format`, with replacement\</span>
<span class="sd">            fields defined from the keys from the current entry of results and aggregated states.\</span>

<span class="sd">            :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;set_path_format is deprecated; set when creating</span>
<span class="s1">                         the database object instead with the nonscalar_output flag&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="o">.</span><span class="n">dirname_fmt</span> <span class="o">=</span> <span class="nb">format</span></div>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__stack&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Do some checks on the relative data directory before we consider overwriting</span>
        <span class="c1"># the master db.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                          The base directory for relative data is</span>
<span class="s1">                          r&quot;{os.path.abspath(self.path)}&quot;,</span>
<span class="s1">                          but it already exists and is not a directory.</span>
<span class="s1">                          Remove or move the file at this path, or change</span>
<span class="s1">                          the path to the master database.</span>
<span class="s1">                       &#39;&#39;&#39;</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">txt</span><span class="p">))</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                          The master database will be overwritten, but the relative data directory,</span>
<span class="s1">                          r&quot;{os.path.abspath(self.path)}&quot;,</span>
<span class="s1">                          already contains data entries. These would become unindexed zombie data on</span>
<span class="s1">                          overwriting the master database. Remove or move the relative data directory</span>
<span class="s1">                          before running the test.</span>
<span class="s1">                      &#39;&#39;&#39;</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">txt</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__stack</span> <span class="o">=</span> <span class="n">ExitStack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stack</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__stack</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="o">.</span><span class="n">write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stack</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stack</span>
                <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ex</span>

        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="StatesToRelationalTable.setup"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Open the file or database connection.</span>
<span class="sd">            This is an abstract base method (to be overridden by inheriting classes)</span>

<span class="sd">            :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="StatesToRelationalTable.open"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This must be implemented by a subclass to open the data storage resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="StatesToRelationalTable.close"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToRelationalTable.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Close the file or database connection.</span>
<span class="sd">            This is an abstract base method (to be overridden by inheriting classes)</span>

<span class="sd">            :return: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<div class="viewcode-block" id="StatesToCSV"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToCSV">[docs]</a><span class="k">class</span> <span class="nc">StatesToCSV</span><span class="p">(</span><span class="n">StatesToRelationalTable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Store data and states to disk into a master database formatted as a comma-separated value (CSV) file.</span>

<span class="sd">        This extends :class:`StateAggregator` to support</span>

<span class="sd">        #. queuing aggregate state of devices by lists of dictionaries;</span>
<span class="sd">        #. custom metadata in each queued aggregate state entry; and</span>
<span class="sd">        #. custom response to non-scalar data (such as relational databasing).</span>

<span class="sd">        :param str path: Base path to use for the master database</span>
<span class="sd">        :param bool overwrite: Whether to overwrite the master database if it exists (otherwise, append)</span>
<span class="sd">        :param text_relational_min: Text with at least this many characters is stored as a relational text file instead of directly in the database</span>
<span class="sd">        :param force_relational: A list of columns that should always be stored as relational data instead of directly in the database</span>
<span class="sd">        :param nonscalar_file_type: The data type to use in non-scalar (tabular, vector, etc.) relational data</span>
<span class="sd">        :param metadata_dirname: The name of the subdirectory that should be used to store metadata (device connection parameters, etc.)</span>
<span class="sd">        :param tar: Whether to store the relational data within directories in a tar file, instead of subdirectories</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">nonscalar_file_type</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span>

<div class="viewcode-block" id="StatesToCSV.open"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToCSV.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Instead of calling `open` directly, consider using</span>
<span class="sd">            `with` statements to guarantee proper disconnection</span>
<span class="sd">            if there is an error. For example, the following</span>
<span class="sd">            sets up a connected instance::</span>

<span class="sd">                with StatesToCSV(&#39;my.csv&#39;) as db:</span>
<span class="sd">                    ### do the data acquisition here</span>
<span class="sd">                    pass</span>

<span class="sd">            would instantiate a `StatesToCSV` instance, and also guarantee</span>
<span class="sd">            a final attempt to write unwritten data is written, and that</span>
<span class="sd">            the file is closed when exiting the `with` block, even if there</span>
<span class="sd">            is an exception.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;.csv&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_label</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="StatesToCSV.close"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToCSV.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_master</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_write_master</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Write queued rows of data to csv. This is called automatically on :func:`close`, or when</span>
<span class="sd">            exiting a `with` block.</span>

<span class="sd">            If the class was created with overwrite=True, then the first call to _write_master() will overwrite</span>
<span class="sd">            the preexisting file; subsequent calls append.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">isfirst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">pending</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span>
        <span class="n">pending</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_label</span>
        <span class="n">pending</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span>
        <span class="k">if</span> <span class="n">isfirst</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pending</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_index</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">isfirst</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="StatesToSQLite"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToSQLite">[docs]</a><span class="k">class</span> <span class="nc">StatesToSQLite</span><span class="p">(</span><span class="n">StatesToRelationalTable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Store data and states to disk into an an sqlite master database.</span>

<span class="sd">        This extends :class:`StateAggregator` to support</span>

<span class="sd">        #. queuing aggregate state of devices by lists of dictionaries;</span>
<span class="sd">        #. custom metadata in each queued aggregate state entry; and</span>
<span class="sd">        #. custom response to non-scalar data (such as relational databasing).</span>

<span class="sd">        :param str path: Base path to use for the master database</span>
<span class="sd">        :param bool overwrite: Whether to overwrite the master database if it exists (otherwise, append)</span>
<span class="sd">        :param text_relational_min: Text with at least this many characters is stored as a relational text file instead of directly in the database</span>
<span class="sd">        :param force_relational: A list of columns that should always be stored as relational data instead of directly in the database</span>
<span class="sd">        :param nonscalar_file_type: The data type to use in non-scalar (tabular, vector, etc.) relational data</span>
<span class="sd">        :param metadata_dirname: The name of the subdirectory that should be used to store metadata (device connection parameters, etc.)</span>
<span class="sd">        :param tar: Whether to store the relational data within directories in a tar file, instead of subdirectories</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">index_label</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>  <span class="c1"># Don&#39;t change this or sqlite breaks :(</span>
    <span class="n">master_filename</span> <span class="o">=</span> <span class="s1">&#39;master.db&#39;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;master&#39;</span>

<div class="viewcode-block" id="StatesToSQLite.open"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToSQLite.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Instead of calling `open` directly, consider using</span>
<span class="sd">            `with` statements to guarantee proper disconnection</span>
<span class="sd">            if there is an error. For example, the following</span>
<span class="sd">            sets up a connected instance::</span>

<span class="sd">                with StatesToSQLite(&#39;my.db&#39;) as db:</span>
<span class="sd">                    ### do the data acquisition here</span>
<span class="sd">                    pass</span>

<span class="sd">            would instantiate a `StatesToCSV` instance, and also guarantee</span>
<span class="sd">            a final attempt to write unwritten data is written, and that</span>
<span class="sd">            the file is closed when exiting the `with` block, even if there</span>
<span class="sd">            is an exception.</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="c1">#        if not self.path.lower().endswith(&#39;.db&#39;):</span>
<span class="c1">#            self.path += &#39;.db&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_filename</span><span class="p">)</span>

        <span class="c1"># Create an engine via sqlalchemy</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">create_engine</span>  <span class="c1"># database connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
            <span class="c1"># Read the last row to 1) list the columns and 2) get index</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;select * from </span><span class="si">{self.table_name}</span><span class="s1"> order by </span><span class="si">{self.index_label}</span><span class="s1"> desc limit 1&#39;</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span>
                                   <span class="n">index_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inprogress</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="StatesToSQLite.close"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToSQLite.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_master</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_write_master</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Write queued rows of data to the database. This also is called automatically on :func:`close`, or when</span>
<span class="sd">            exiting a `with` block.</span>

<span class="sd">            If the class was created with overwrite=True, then the first call to _write_master() will overwrite</span>
<span class="sd">            the preexisting file; subsequent calls append.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Put together a DataFrame from self.pending that is guaranteed</span>
        <span class="c1"># to include the columns defined in self._columns</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span>
        <span class="n">blank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>

        <span class="c1"># Check for new columns, and insert into the database</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">blank_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">blank</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">new_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">state_cols</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">blank_cols</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new_columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;LogSQLite inserting new state column </span><span class="si">{c}</span><span class="s1"> into database&#39;</span><span class="p">)</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_type_name</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;alter table </span><span class="si">{self.table_name}</span><span class="s2"> add column </span><span class="si">{c}</span><span class="s2"> </span><span class="si">{column_type}</span><span class="s2"> default NULL&quot;</span>
                <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Form the new database row</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">blank</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>

        <span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">ArgumentError</span>

        <span class="c1"># Append to db</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
                      <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ArgumentError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;failed to convert index label </span><span class="si">{self.index_label}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ArgumentError</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="StatesToSQLite.key"><a class="viewcode-back" href="../../labbench.html#labbench.data.StatesToSQLite.key">[docs]</a>    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The key determines the SQL column name. df.to_sql does not seem</span>
<span class="sd">            to support column names that include spaces</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{name.replace(&#39; &#39;, &#39;_&#39;)}_</span><span class="si">{attr}</span><span class="s2">&quot;</span></div>

    <span class="k">def</span> <span class="nf">_sql_type_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pandas.io.sql</span> <span class="k">import</span> <span class="n">_SQL_TYPES</span>

        <span class="n">col_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_notnull_col_dtype</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s1">&#39;timedelta64&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the &#39;timedelta&#39; type is not supported, and will be </span><span class="se">\</span>
<span class="s2">                           written as integer values (ns frequency) to the</span><span class="se">\</span>
<span class="s2">                           database.&quot;</span><span class="p">)</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>

        <span class="k">elif</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s2">&quot;datetime64&quot;</span><span class="p">:</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span>

        <span class="k">elif</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s2">&quot;empty&quot;</span><span class="p">:</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>

        <span class="k">elif</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Complex datatypes not supported&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">col_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_SQL_TYPES</span><span class="p">:</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>

        <span class="k">return</span> <span class="n">_SQL_TYPES</span><span class="p">[</span><span class="n">col_type</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_notnull_col_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer datatype of the Series col.  In case the dtype of col is &#39;object&#39;</span>
<span class="sd">        and it contains NA values, this infers the datatype of the not-NA</span>
<span class="sd">        values.  Needed for inserting typed data containing NULLs, GH8778.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col_for_inference</span> <span class="o">=</span> <span class="n">col</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="n">notnulldata</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">notnulldata</span><span class="p">):</span>
                <span class="n">col_for_inference</span> <span class="o">=</span> <span class="n">notnulldata</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">infer_dtype</span><span class="p">(</span><span class="n">col_for_inference</span><span class="p">)</span></div>


<div class="viewcode-block" id="to_feather"><a class="viewcode-back" href="../../labbench.html#labbench.data.to_feather">[docs]</a><span class="k">def</span> <span class="nf">to_feather</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write a dataframe to a feather file on disk. Any index will be moved</span>
<span class="sd">    to a column, index and column name metadata will be removed,</span>
<span class="sd">    and columns names will be changed to a string.</span>

<span class="sd">    :param data: dataframe to write to disk</span>
<span class="sd">    :param path: path to file to write</span>
<span class="sd">    :return: None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">iname</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">cname</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">str</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">iname</span>
        <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">cname</span></div>


<span class="k">def</span> <span class="nf">read_sqlite</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">index_col</span><span class="o">=</span><span class="n">StatesToRelationalTable</span><span class="o">.</span><span class="n">index_label</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Wrapper to that uses pandas.read_sql_table to load a table from an sqlite database at the specified path.</span>

<span class="sd">    :param path: sqlite database path</span>
<span class="sd">    :param table_name: name of table in the sqlite database</span>
<span class="sd">    :param columns: columns to query and return, or None (default) to return all columns</span>
<span class="sd">    :param nrows: number of rows of data to read, or None (default) to return all rows</span>
<span class="sd">    :param index_col: the name of the column to use as the index</span>
<span class="sd">    :return: pandas.DataFrame instance containing data loaded from `path`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">create_engine</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;sqlite:///</span><span class="si">{path}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span>
        <span class="n">table_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">nrows</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="n">reader_guess</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">,</span>
                <span class="s1">&#39;pickle&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">,</span>
                <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">read_sqlite</span><span class="p">,</span>
                <span class="s1">&#39;sqlite&#39;</span><span class="p">:</span> <span class="n">read_sqlite</span><span class="p">,</span>
                <span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">,</span>
                <span class="s1">&#39;csv&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">reader_guess</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="n">read_feather</span><span class="p">,</span>
                         <span class="s1">&#39;feather&#39;</span><span class="p">:</span> <span class="n">read_feather</span><span class="p">})</span>
<span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s1">&#39;feather format is not available in this pandas installation, and will not be supported in labbench&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="read"><a class="viewcode-back" href="../../labbench.html#labbench.data.read">[docs]</a><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Read tabular data from a file in one of various formats</span>
<span class="sd">    using pandas.</span>

<span class="sd">    :param str path: path to the  data file.</span>
<span class="sd">    :param columns: a column or iterable of multiple columns to return from the data file, or None (the default) to return all columns</span>
<span class="sd">    :param nrows: number of rows to read at the beginning of the table, or None (the default) to read all rows</span>
<span class="sd">    :param str format: data file format, one of [&#39;pickle&#39;,&#39;feather&#39;,&#39;csv&#39;,&#39;json&#39;,&#39;csv&#39;], or &#39;auto&#39; (the default) to guess from the file extension</span>
<span class="sd">    :param kws: additional keyword arguments to pass to the pandas read_&lt;ext&gt; function matching the file extension</span>
<span class="sd">    :return: pandas.DataFrame instance containing data read from file</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;file is empty&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;can only guess format for string path - specify extension&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">reader_guess</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&quot;couldn&#39;t guess a reader from extension of file </span><span class="si">{path_or_buf}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reader</span> <span class="o">==</span> <span class="n">read_sqlite</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">reader</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">nrows</span><span class="p">]</span></div>


<span class="k">class</span> <span class="nc">MungeTarReader</span><span class="p">:</span>
    <span class="n">tarnames</span> <span class="o">=</span> <span class="s1">&#39;data.tar&#39;</span><span class="p">,</span> <span class="s1">&#39;data.tar.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data.tar.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;data.tar.lz4&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">tarname</span><span class="o">=</span><span class="s1">&#39;data.tar&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tarname</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">,</span>\
                <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ex</span>


<span class="k">class</span> <span class="nc">MungeDirectoryReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MungeReader</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39; Guess the type of munging performed on the relational data, and return</span>
<span class="sd">        a reader suited to loading that file.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="sd">&#39;&#39;&#39; TODO: Make this smarter, perhaps by trying to read an entry from</span>
<span class="sd">        the master database</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">MungeTarReader</span><span class="o">.</span><span class="n">tarnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">n</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">MungeTarReader</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">tarname</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MungeDirectoryReader</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>


<div class="viewcode-block" id="read_relational"><a class="viewcode-back" href="../../labbench.html#labbench.data.read_relational">[docs]</a><span class="k">def</span> <span class="nf">read_relational</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">expand_col</span><span class="p">,</span> <span class="n">master_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">master_nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">master_format</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">prepend_column_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Flatten a relational database table by loading the table located each row of</span>
<span class="sd">        `master[expand_col]`. The value of each column in this row</span>
<span class="sd">        is copied to the loaded table. The columns in the resulting table generated</span>
<span class="sd">        on each row are downselected</span>
<span class="sd">        according to `master_cols` and `target_cols`. Each of the resulting tables</span>
<span class="sd">        is concatenated and returned.</span>

<span class="sd">        The expanded dataframe may be very large, making downselecting a practical</span>
<span class="sd">        necessity in some scenarios.</span>

<span class="sd">        TODO: Support for a list of expand_col?</span>

<span class="sd">        :param pandas.DataFrame master: the master database, consisting of columns containing data and columns containing paths to data files</span>
<span class="sd">        :param str expand_col: the column in the master database containing paths to    data files that should be expanded</span>
<span class="sd">        :param master_cols: a column (or array-like iterable of multiple columns) listing the master columns to include in the expanded dataframe, or None (the default) pass all columns from `master`</span>
<span class="sd">        :param target_cols: a column (or array-like iterable of multiple columns) listing the master columns to include in the expanded dataframe, or None (the default) to pass all columns loaded from each master[expand_col]</span>
<span class="sd">        :param master_path: a string containing the full path to the master database (to help find the relational files)</span>
<span class="sd">        :param bool prepend_column_name: whether to prepend the name of the expanded column from the master database</span>
<span class="sd">        :returns: the expanded dataframe</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># if not isinstance(master, (pd.DataFrame,pd.Series)):</span>
    <span class="c1">#     raise ValueError(&#39;expected master to be a DataFrame instance, but it is {} instead&#39;\</span>
    <span class="c1">#                      .format(repr(type(master))))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_col</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;expand_col must a str, not {type(expand_col)}&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">master_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">master_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">master_cols</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">expand_col</span><span class="p">]</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">master_cols</span><span class="p">,</span>
                  <span class="n">nrows</span><span class="o">=</span><span class="n">master_nrows</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">master_format</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">MungeReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">master</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">expand_col</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">expand_col</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">sub</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">expand_col</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">target_cols</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prepend_column_name</span><span class="p">:</span>
                <span class="n">prepend</span> <span class="o">=</span> <span class="n">expand_col</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prepend</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># Rename columns</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">prepend</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">sub</span><span class="p">[</span><span class="n">prepend</span> <span class="o">+</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># # Downselect master columns</span>
            <span class="c1"># if master_cols is not None:</span>
            <span class="c1">#     row = row[master_cols]</span>

            <span class="c1"># Add in columns from the master</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">sub</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">yield</span> <span class="n">sub</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">generate</span><span class="p">(),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench v0.20</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>